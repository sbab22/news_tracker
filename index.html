<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Latest Junior Mining News</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
  h1 { margin-top: 0; }
  #status { font-size: 0.9em; color: #555; margin-bottom: 10px; white-space: pre-wrap; }
  .news-item { padding: 12px 10px; border-bottom: 1px solid #ddd; }
  .news-item a { font-weight: 700; color: #2a4d69; text-decoration: none; }
  .news-item a:hover { text-decoration: underline; }
  .date { font-size: 0.9em; color: #555; margin-top: 2px; }
  .muted { color: #777; }
  .error { color: #b00020; }
</style>
</head>
<body>
<h1>Latest Junior Mining News</h1>
<div id="status" class="muted">Starting…</div>
<div id="news">Loading…</div>

<script>
/* ===================== Config ===================== */
const FEED_URL = 'https://www.juniorminingnetwork.com/index.php?option=com_obrss&task=feed&id=1:press-releases&format=feed&Itemid=688';
const USE_PROXIES = true; // use CORS proxies for cross-origin feeds
const MAX_ITEMS = 20;

/* ================ Multi-proxy fetch (for cross-origin) ================ */
function viaCorsproxy(url) { return 'https://corsproxy.io/?' + encodeURIComponent(url); }
function viaAllOrigins(url) { return 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url); }
function viaJina(url) {
  const withHttps = url.startsWith('https://') ? url : 'https://' + url.replace(/^https?:\/\//,'');
  return 'https://r.jina.ai/http/' + withHttps.replace(/^https?:\/\//,'');
}

async function fetchWithFallbacks(url, { asText = true } = {}) {
  const attempts = USE_PROXIES
    ? [viaCorsproxy(url), viaAllOrigins(url), viaJina(url)]
    : [url, viaCorsproxy(url), viaAllOrigins(url), viaJina(url)];

  let lastErr;
  for (const u of attempts) {
    try {
      logStatus('Trying: ' + u);
      const res = await fetch(u);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return asText ? await res.text() : await res.arrayBuffer();
    } catch (e) {
      lastErr = e;
      logStatus('Failed: ' + u + ' — ' + e.message);
      console.warn('Fetch failed', u, e);
    }
  }
  throw lastErr ?? new Error('All attempts failed');
}

function logStatus(msg, isError = false) {
  const el = document.getElementById('status');
  el.textContent += (el.textContent ? '\n' : '') + msg;
  if (isError) el.classList.add('error');
}

/* ================= Helpers ================= */
function parseXmlOrThrow(text) {
  const xml = new DOMParser().parseFromString(text, 'application/xml');
  if (xml.querySelector('parsererror')) {
    const snippet = text.slice(0, 200).replace(/\s+/g, ' ');
    throw new Error('XML parse error. First 200 chars: ' + snippet);
  }
  return xml;
}

function getItemLink(item) {
  // RSS: <link>text</link>
  let link = item.querySelector('link')?.textContent?.trim() || '';
  // Atom: <link href="...">
  if (!link) link = item.querySelector('link[rel="alternate"]')?.getAttribute('href') || '';
  if (!link) link = item.querySelector('link')?.getAttribute('href') || '';
  return link || '#';
}

function getItemDate(item) {
  const s =
    item.querySelector('pubDate')?.textContent?.trim() ||
    item.querySelector('updated')?.textContent?.trim() ||
    item.querySelector('published')?.textContent?.trim() ||
    item.querySelector('dc\\:date')?.textContent?.trim() ||
    '';
  if (!s) return { iso: null, nice: 'No Date' };
  const iso = new Date(s).toISOString();
  const nice = new Date(iso).toLocaleString();
  return { iso, nice };
}

/* ================= Main render ================= */
async function render() {
  const newsEl = document.getElementById('news');
  try {
    logStatus('Fetching RSS…');
    const xmlText = await fetchWithFallbacks(FEED_URL);

    logStatus('Parsing XML…');
    const xml = parseXmlOrThrow(xmlText);

    // Handle both RSS (<item>) and Atom (<entry>)
    const items = Array.from(
      xml.querySelectorAll('item').length
        ? xml.querySelectorAll('item')
        : xml.querySelectorAll('entry')
    );
    if (!items.length) throw new Error('No items found in feed.');

    newsEl.innerHTML = '';
    const N = Math.min(MAX_ITEMS, items.length);

    for (let i = 0; i < N; i++) {
      const it = items[i];
      const title = it.querySelector('title')?.textContent?.trim() || 'No Title';
      const link  = getItemLink(it);
      const { nice } = getItemDate(it);

      const el = document.createElement('div');
      el.className = 'news-item';
      el.innerHTML = `
        <a href="${link}" target="_blank" rel="noopener">${title}</a>
        <div class="date">${nice}</div>
      `;
      newsEl.appendChild(el);
    }

    logStatus('Done. Rendered ' + N + ' items.');
  } catch (e) {
    console.error(e);
    logStatus('ERROR: ' + e.message, true);
    newsEl.innerHTML = '<div class="error">Failed to load. See status above.</div>';
  }
}

render();
</script>
</body>
</html>
