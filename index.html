<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Latest Junior Mining News</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
  h1 { margin-top: 0; }
  #status { font-size: 0.9em; color: #555; margin-bottom: 10px; white-space: pre-wrap; }
  .news-item { padding: 12px 10px; border-bottom: 1px solid #ddd; }
  .row { display: flex; gap: 14px; align-items: center; flex-wrap: wrap; }
  .news-item a { font-weight: 700; color: #2a4d69; text-decoration: none; }
  .news-item a:hover { text-decoration: underline; }
  .date { font-size: 0.9em; color: #555; margin-top: 4px; }
  .muted { color: #777; }
  .error { color: #b00020; }

  /* Inline editor to the right of title */
  .inline-editor { display: inline-flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .inline-editor input {
    font: inherit;
    padding: 4px 6px;
    border: 1px solid #cfcfcf;
    border-radius: 6px;
    background: #fff;
    min-width: 70px;
  }
  .inline-editor input.ticker { min-width: 80px; }
  .inline-editor input.price { width: 100px; }
  .change { font-size: 0.92em; }
  .change.up { color: #0a7a0a; }
  .change.down { color: #b00020; }
</style>
</head>
<body>
<h1>Latest Junior Mining News</h1>
<div id="status" class="muted">Starting…</div>
<div id="news">Loading…</div>

<script>
/* ===================== Config ===================== */
const FEED_URL = 'https://www.juniorminingnetwork.com/index.php?option=com_obrss&task=feed&id=1:press-releases&format=feed&Itemid=688';
const USE_PROXIES = true; // use CORS proxies for cross-origin feeds
const MAX_ITEMS = 20;

/* ================ Multi-proxy fetch (for cross-origin) ================ */
function viaCorsproxy(url) { return 'https://corsproxy.io/?' + encodeURIComponent(url); }
function viaAllOrigins(url) { return 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url); }
function viaJina(url) {
  const withHttps = url.startsWith('https://') ? url : 'https://' + url.replace(/^https?:\/\//,'');
  return 'https://r.jina.ai/http/' + withHttps.replace(/^https?:\/\//,'');
}

async function fetchWithFallbacks(url, { asText = true } = {}) {
  const attempts = USE_PROXIES
    ? [viaCorsproxy(url), viaAllOrigins(url), viaJina(url)]
    : [url, viaCorsproxy(url), viaAllOrigins(url), viaJina(url)];

  let lastErr;
  for (const u of attempts) {
    try {
      logStatus('Trying: ' + u);
      const res = await fetch(u);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return asText ? await res.text() : await res.arrayBuffer();
    } catch (e) {
      lastErr = e;
      logStatus('Failed: ' + u + ' — ' + e.message);
      console.warn('Fetch failed', u, e);
    }
  }
  throw lastErr ?? new Error('All attempts failed');
}

function logStatus(msg, isError = false) {
  const el = document.getElementById('status');
  el.textContent += (el.textContent ? '\n' : '') + msg;
  if (isError) el.classList.add('error');
}

/* ================= Helpers ================= */
function parseXmlOrThrow(text) {
  const xml = new DOMParser().parseFromString(text, 'application/xml');
  if (xml.querySelector('parsererror')) {
    const snippet = text.slice(0, 200).replace(/\s+/g, ' ');
    throw new Error('XML parse error. First 200 chars: ' + snippet);
  }
  return xml;
}

function getItemLink(item) {
  // RSS: <link>text</link>
  let link = item.querySelector('link')?.textContent?.trim() || '';
  // Atom: <link href="...">
  if (!link) link = item.querySelector('link[rel="alternate"]')?.getAttribute('href') || '';
  if (!link) link = item.querySelector('link')?.getAttribute('href') || '';
  return link || '#';
}

function getItemDate(item) {
  const s =
    item.querySelector('pubDate')?.textContent?.trim() ||
    item.querySelector('updated')?.textContent?.trim() ||
    item.querySelector('published')?.textContent?.trim() ||
    item.querySelector('dc\\:date')?.textContent?.trim() ||
    '';
  if (!s) return { iso: null, nice: 'No Date' };
  const iso = new Date(s).toISOString();
  const nice = new Date(iso).toLocaleString();
  return { iso, nice };
}

/* ============== Simple storage (so your inputs persist) ============== */
const storeKey = (id) => 'news-notes::' + id;
function saveNotes(id, data) {
  try { localStorage.setItem(storeKey(id), JSON.stringify(data)); } catch {}
}
function loadNotes(id) {
  try { return JSON.parse(localStorage.getItem(storeKey(id)) || 'null'); } catch { return null; }
}

/* ================= Render ================= */
function percentChange(before, after) {
  const a = parseFloat(before), b = parseFloat(after);
  if (!isFinite(a) || !isFinite(b) || a === 0) return null;
  return ((b - a) / a) * 100;
}

async function render() {
  const newsEl = document.getElementById('news');
  try {
    logStatus('Fetching RSS…');
    const xmlText = await fetchWithFallbacks(FEED_URL);

    logStatus('Parsing XML…');
    const xml = parseXmlOrThrow(xmlText);

    // Handle both RSS (<item>) and Atom (<entry>)
    const items = Array.from(
      xml.querySelectorAll('item').length
        ? xml.querySelectorAll('item')
        : xml.querySelectorAll('entry')
    );
    if (!items.length) throw new Error('No items found in feed.');

    newsEl.innerHTML = '';
    const N = Math.min(MAX_ITEMS, items.length);

    for (let i = 0; i < N; i++) {
      const it = items[i];
      const title = it.querySelector('title')?.textContent?.trim() || 'No Title';
      const link  = getItemLink(it);
      const { nice } = getItemDate(it);

      const id = link || title; // key for persistence

      // Build UI
      const el = document.createElement('div');
      el.className = 'news-item';

      const row = document.createElement('div');
      row.className = 'row';

      const a = document.createElement('a');
      a.href = link; a.target = '_blank'; a.rel = 'noopener';
      a.textContent = title;

      const editor = document.createElement('div');
      editor.className = 'inline-editor';
      editor.innerHTML = `
        <input class="ticker" placeholder="Ticker">
        <input class="price before" type="number" step="0.0001" placeholder="Price T−2d">
        <input class="price after"  type="number" step="0.0001" placeholder="Price T+2d">
        <span class="change muted">—</span>
      `;

      row.appendChild(a);
      row.appendChild(editor);
      el.appendChild(row);

      const dateDiv = document.createElement('div');
      dateDiv.className = 'date';
      dateDiv.textContent = nice;
      el.appendChild(dateDiv);

      newsEl.appendChild(el);

      // Restore saved values (if any)
      const saved = loadNotes(id);
      const $ticker = editor.querySelector('.ticker');
      const $before = editor.querySelector('.before');
      const $after  = editor.querySelector('.after');
      const $chg    = editor.querySelector('.change');

      if (saved) {
        if (saved.ticker) $ticker.value = saved.ticker;
        if (saved.before != null) $before.value = saved.before;
        if (saved.after  != null) $after.value  = saved.after;
      }

      const recompute = () => {
        const c = percentChange($before.value, $after.value);
        $chg.classList.remove('up','down','muted');
        if (c == null) {
          $chg.textContent = '—';
          $chg.classList.add('muted');
        } else {
          $chg.textContent = (c >= 0 ? '+' : '') + c.toFixed(2) + '%';
          $chg.classList.add(c >= 0 ? 'up' : 'down');
        }
        saveNotes(id, { ticker: $ticker.value.trim(), before: $before.value, after: $after.value });
      };

      [$ticker, $before, $after].forEach(inp => {
        inp.addEventListener('input', recompute);
        inp.addEventListener('blur', recompute);
      });

      // Initial compute
      recompute();
    }

    logStatus('Done. Rendered ' + N + ' items.');
  } catch (e) {
    console.error(e);
    logStatus('ERROR: ' + e.message, true);
    newsEl.innerHTML = '<div class="error">Failed to load. See status above.</div>';
  }
}

render();
</script>
</body>
</html>
